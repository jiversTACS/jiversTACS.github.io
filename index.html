<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UnmatchName Matcher</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
      background-color: #f4f4f4;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h2 { text-align: center; }
    .upload-container {
      display: flex;
      gap: 20px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 30px;
    }
    .upload-section {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .drop-zone {
      padding: 20px;
      border: 2px dashed #ccc;
      border-radius: 8px;
      background-color: white;
      text-align: center;
      width: 300px;
      cursor: pointer;
    }
    .drop-zone.dragover {
      background-color: #e0f7fa;
      border-color: #00acc1;
    }
    input[type="file"] { display: none; }
    button {
      display: block;
      width: 200px;
      margin: 0 auto;
      padding: 10px;
      font-size: 16px;
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover { background-color: #0056b3; }
    #status {
      margin-top: 20px;
      text-align: center;
    }
  </style>
</head>
<body>
  <h2>UnmatchName Matcher</h2>
  <div class="upload-container">
    <div class="upload-section">
      <div class="drop-zone" id="unmatchDrop">Upload UnmatchName File</div>
      <input type="file" id="unmatchFile" accept=".csv">
    </div>
    <div class="upload-section">
      <div class="drop-zone" id="pivotDrop">Upload Pivot File</div>
      <input type="file" id="pivotFile" accept=".csv">
    </div>
  </div>

  <button onclick="processFiles()">Generate Output</button>
  <p id="status"></p>

  <script>
    function setupDropZone(dropId, inputId) {
      const dropZone = document.getElementById(dropId);
      const fileInput = document.getElementById(inputId);
      dropZone.addEventListener('click', () => fileInput.click());
      dropZone.addEventListener('dragover', e => {
        e.preventDefault();
        dropZone.classList.add('dragover');
      });
      dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
      dropZone.addEventListener('drop', e => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        fileInput.files = e.dataTransfer.files;
      });
    }

    setupDropZone("unmatchDrop", "unmatchFile");
    setupDropZone("pivotDrop", "pivotFile");

    function processFiles() {
      const unmatchFile = document.getElementById("unmatchFile").files[0];
      const pivotFile = document.getElementById("pivotFile").files[0];
      if (!unmatchFile || !pivotFile) {
        alert("Please upload both files.");
        return;
      }

      document.getElementById("status").innerText = "Processing...";

      Papa.parse(unmatchFile, {
        header: true,
        skipEmptyLines: true,
        complete: function(unmatchResults) {
          const unmatchRows = unmatchResults.data.map(row => ({
            keyA: row[Object.keys(row)[0]]?.trim(),
            keyC: row[Object.keys(row)[2]]?.trim(),
            extra: [row[Object.keys(row)[4]], row[Object.keys(row)[5]], row[Object.keys(row)[6]], row[Object.keys(row)[7]]],
            full: row
          }));

          Papa.parse(pivotFile, {
            header: true,
            skipEmptyLines: true,
            complete: function(pivotResults) {
              const pivotMap = new Map();
              pivotResults.data.forEach(row => {
                if (row[Object.keys(row)[10]]?.includes("-RE")) {
                  const keyA = row[Object.keys(row)[0]]?.trim();
                  const keyI = row[Object.keys(row)[8]]?.trim();
                  const extras = [row[Object.keys(row)[1]], row[Object.keys(row)[2]], row[Object.keys(row)[3]], row[Object.keys(row)[10]]];
                  if (!pivotMap.has(keyA)) pivotMap.set(keyA, []);
                  pivotMap.get(keyA).push({ keyI, extras });
                }
              });

              const singleMatch = [];
              const multiMatch = [];
              const groupByKeyA = {};

              unmatchRows.forEach(row => {
                if (!groupByKeyA[row.keyA]) groupByKeyA[row.keyA] = new Set();
                groupByKeyA[row.keyA].add(row.keyC);
              });

              Object.entries(groupByKeyA).forEach(([keyA, set]) => {
                const matchedRows = unmatchRows.filter(r => r.keyA === keyA);
                if (set.size > 1) multiMatch.push(...matchedRows);
                else singleMatch.push(...matchedRows);
              });

              exportCSV(singleMatch, "single_match.csv");
              exportCSV(multiMatch, "multi_match.csv");

              document.getElementById("status").innerText = `Done! Downloaded ${singleMatch.length} single-match rows and ${multiMatch.length} multi-match rows.`;
            }
          });
        }
      });
    }

    function exportCSV(data, filename) {
      if (!data.length) return;
      const headers = Object.keys(data[0].full);
      const rows = [headers.join(",")];
      data.forEach(r => {
        const row = headers.map(h => JSON.stringify(r.full[h] || ""));
        rows.push(row.join(","));
      });
      const blob = new Blob([rows.join("\n")], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  </script>
</body>
</html>
