<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UnmatchName Matcher</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
      background-color: #f4f4f4;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h2 { text-align: center; }
    .upload-container {
      display: flex;
      gap: 20px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 30px;
    }
    .upload-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 30px;
    }
    .drop-zone {
      padding: 20px;
      border: 2px dashed #ccc;
      border-radius: 8px;
      background-color: white;
      text-align: center;
      width: 300px;
      cursor: pointer;
    }
    .drop-zone.dragover {
      background-color: #e0f7fa;
      border-color: #00acc1;
    }
    input[type="file"] { display: none; }
    button {
      display: block;
      width: 200px;
      margin: 0 auto;
      padding: 10px;
      font-size: 16px;
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover { background-color: #0056b3; }
    #status {
      margin-top: 20px;
      text-align: center;
    }
    .file-preview {
  background: #fff;
  padding: 10px;
  border: 1px solid #ccc;
  margin-top: 10px;
  border-radius: 5px;
  font-size: 0.9em;
  max-height: 150px;
  overflow-y: auto;
  overflow-x: auto;
  width: 100%;
  max-width: 500px;
  box-sizing: border-box;
  white-space: nowrap;
}

.preview-wrapper {
  display: none;
  text-align: left;
  margin-top: 10px;
}

  </style>
</head>
<body>
  <h2>UnmatchName Matcher</h2>
  <div class="upload-section">
  <div class="drop-zone" id="unmatchDrop">Drop or click to upload UnmatchName File</div>
  <input type="file" id="unmatchFile" accept=".csv" style="display:none">

  <div class="preview-wrapper" id="unmatchPreviewWrapper" style="display: none;">
    <label><strong>Preview</strong></label>
    <div class="file-preview" id="unmatchPreview"></div>
  </div>
</div>

<div class="upload-section">
  <div class="drop-zone" id="pivotDrop">Drop or click to upload Pivot File</div>
  <input type="file" id="pivotFile" accept=".csv" style="display:none">

  <div class="preview-wrapper" id="pivotPreviewWrapper" style="display: none;">
    <label><strong>Preview</strong></label>
    <div class="file-preview" id="pivotPreview"></div>
  </div>
</div>


  <button onclick="processFiles()">Generate Output</button>
  <p id="status"></p>

  <script>
    function setupDropZone(dropId, inputId, previewId, wrapperId) {
  const dropZone = document.getElementById(dropId);
  const input = document.getElementById(inputId);
  const preview = document.getElementById(previewId);
  const wrapper = document.getElementById(wrapperId);

  function showPreview(file) {
    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      preview: 5,
      complete: function(results) {
        const headers = results.meta.fields;
        let html = `<strong>${file.name}</strong><br><table><tr>`;
        headers.forEach(h => html += `<th>${h}</th>`);
        html += '</tr>';
        results.data.forEach(row => {
          html += '<tr>';
          headers.forEach(h => html += `<td>${row[h]}</td>`);
          html += '</tr>';
        });
        html += '</table>';
        preview.innerHTML = html;
        wrapper.style.display = 'block';
      }
    });
  }

  dropZone.addEventListener('click', () => input.click());

  dropZone.addEventListener('dragover', e => {
    e.preventDefault();
    dropZone.classList.add('dragover');
  });

  dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));

  dropZone.addEventListener('drop', e => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file) {
      input.files = e.dataTransfer.files;
      showPreview(file);
    }
  });

  input.addEventListener('change', () => {
    if (input.files[0]) showPreview(input.files[0]);
  });
}


    setupDropZone("unmatchDrop", "unmatchFile", "unmatchPreview", "unmatchPreviewWrapper");
setupDropZone("pivotDrop", "pivotFile", "pivotPreview", "pivotPreviewWrapper");


    function processFiles() {
  const unmatchFile = document.getElementById("unmatchFile").files[0];
  const pivotFile = document.getElementById("pivotFile").files[0];
  if (!unmatchFile || !pivotFile) {
    alert("Please upload both files.");
    return;
  }

  document.getElementById("status").innerText = "Processing...";

  Papa.parse(unmatchFile, {
    header: true,
    skipEmptyLines: true,
    complete: function(unmatchResults) {
      Papa.parse(pivotFile, {
        header: true,
        skipEmptyLines: true,
        complete: function(pivotResults) {
          const refMap = new Map(); // DebtorNumber -> Set of Reference2s
          const unmatchGrouped = new Map(); // DebtorNumber -> [unmatchRows]
          const pivotGrouped = new Map();   // DebtorNumber -> [pivotRows]

          const unmatch = unmatchResults.data;
          const pivot = pivotResults.data.filter(
            row => row[Object.keys(row)[10]]?.includes("-RE")
          );

          // Build from unmatch
          unmatch.forEach(row => {
            const a = row[Object.keys(row)[0]]?.trim(); // A
            const c = row[Object.keys(row)[2]]?.trim(); // C
            if (!a || !c) return;

            if (!refMap.has(a)) refMap.set(a, new Set());
            refMap.get(a).add(c);

            if (!unmatchGrouped.has(a)) unmatchGrouped.set(a, []);
            unmatchGrouped.get(a).push({
              Source: "Unmatch",
              DebtorNumber: a,
              UnmatchRef: c,
              E: row[Object.keys(row)[4]],
              F: row[Object.keys(row)[5]],
              G: row[Object.keys(row)[6]],
              H: row[Object.keys(row)[7]],
              PivotRef: "",
              B: "",
              C: "",
              D: "",
              K: ""
            });
          });

          // Build from pivot
          pivot.forEach(row => {
            const a = row[Object.keys(row)[0]]?.trim(); // A
            const i = row[Object.keys(row)[8]]?.trim(); // I
            if (!a || !i) return;

            if (!refMap.has(a)) refMap.set(a, new Set());
            refMap.get(a).add(i);

            if (!pivotGrouped.has(a)) pivotGrouped.set(a, []);
            pivotGrouped.get(a).push({
              Source: "Pivot",
              DebtorNumber: a,
              UnmatchRef: "",
              E: "",
              F: "",
              G: "",
              H: "",
              PivotRef: i,
              B: row[Object.keys(row)[1]],
              C: row[Object.keys(row)[2]],
              D: row[Object.keys(row)[3]],
              K: row[Object.keys(row)[10]]
            });
          });

          // Final output containers
          const singleMatch = [];
          const multiMatch = [];

          refMap.forEach((refSet, debtor) => {
            const target = refSet.size > 1 ? multiMatch : singleMatch;
            const unmatchRows = unmatchGrouped.get(debtor) || [];
            const pivotRows = pivotGrouped.get(debtor) || [];
            target.push(...unmatchRows);
            target.push(...pivotRows);
          });

          exportCSV(singleMatch, "single_match.csv");
          exportCSV(multiMatch, "multi_match.csv");

          document.getElementById("status").innerText =
            `Done! Exported ${singleMatch.length} single-match and ${multiMatch.length} multi-match rows.`;
        }
      });
    }
  });
}



    function exportCSV(data, filename) {
  if (!data.length) return;
  const headers = [
    "Source", "DebtorNumber", "UnmatchRef", "E", "F", "G", "H",
    "PivotRef", "B", "C", "D", "K"
  ];
  const rows = [headers.join(",")];
  data.forEach(row => {
    const line = headers.map(h => JSON.stringify(row[h] ?? ""));
    rows.push(line.join(","));
  });
  const blob = new Blob([rows.join("\n")], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}


  </script>
</body>
</html>
